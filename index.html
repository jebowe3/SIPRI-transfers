<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>US Global Weapons Transfers</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
  <style type="text/css">
    body {
      margin: 0px;
      height: 100%;
      width: 100%;
      background: #FFFFF0;
    }

    #map {
      position: fixed;
      top: 0px;
      bottom: 0px;
      width: 100%;
      background: #030511;
      border-left: 1px solid gray;
    }

    #main-map {
      background-color: #008CBA;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 12px;
      margin: 5px;
      position: absolute;
      top: 45px;
      right: 10px;
    }

    #main-map:hover {
      background-color: #72bcd4;
    }

    /* Set time slider styles */
    #slider {
      position: absolute;
      height: 30px;
      bottom: 10px;
      left: 70px;
      z-index: 800;
      background-color: rgba(255, 255, 255, 0.85);
      border-radius: 3px;
      box-shadow: 0px 0px 0px 1px rgba(0, 0, 0, 0.2);
    }

    /* Set temporal legend styles */
    #temporal {
      height: 30px;
      width: 56px;
      background-color: rgba(255, 255, 255, 0.85);
      border-radius: 3px;
      box-shadow: 0px 0px 0px 1px rgba(0, 0, 0, 0.2);
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 800;
    }

    /* Set the styles for the text span in the temporal legend */
    #temporal span {
      font-family: 'Lato', sans-serif;
      font-weight: 300;
      font-style: italic;
      position: inherit;
      font-size: 20px;
      color: rgba(0, 0, 0, 1.0);
      top: 1px;
      left: 4px;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <!-- ui slider -->
  <div id="slider" class="leaflet-control">
    <input type="range" min="1950" max="2023" value="1950" step="1" class="slider" />
  </div>
  <!-- temporal legend -->
  <div id='temporal'>
    <span></span>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script type="text/javascript" src="js/proj4js-compressed.js"></script>
  <script type="text/javascript" src="js/proj4leaflet.js"></script>
  <script type="text/javascript" src="js/L.Graticule.js"></script>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>

  <script type="text/javascript">
    // Sphere Mollweide: http://spatialreference.org/ref/esri/53009/
    const crs = new L.Proj.CRS('ESRI:53009', '+proj=moll +lon_0=0 +x_0=0 +y_0=0 +a=6371000 +b=6371000 +units=m +no_defs', {
      resolutions: [65536, 32768, 16384, 8192, 4096, 2048]
    });

    const map = L.map('map', {
      crs: crs,
      maxZoom: 5,
      minZoom: 1,
      zoomAnimation: false
    });

    L.graticule({
      sphere: true,
      style: {
        color: '#777',
        opacity: 1,
        fillColor: '#050a30',
        fillOpacity: 1,
        weight: 0.5
      }
    }).addTo(map);

    L.graticule({
      style: {
        color: '#777',
        weight: 1,
        opacity: 0.5
      }
    }).addTo(map);

    // Create a feature group to store polygons
    const filteredCountries = L.featureGroup();

    // Load the data and initialize the map
    d3.queue()
      .defer(d3.json, 'data/clipped-world-land.geojson') // the continents, land masses
      .defer(d3.json, 'data/sipri-perc.geojson') // the historical countries layer
      .await(drawMap); // load the layers after the map loads

    function drawMap(err, land, countries) {
      // Reset the slider to the initial year
      $('.slider').val(1950);

      // Create the earth layer (background layer for land masses)
      const earth = L.geoJson(land, {
        style: function(feature) {
          return {
            stroke: 1,
            color: 'grey',
            strokeOpacity: 1,
            weight: 1,
            fillColor: 'black',
            fillOpacity: 1
          };
        }
      }).addTo(map); // Keeps the earth layer from being placed over the circle markers upon map load

      // Create the nations layer but don't add it directly to the map
      nations = L.geoJson(countries, {
        style: function(feature) {
          return {
            stroke: 0.5,
            color: 'grey',
            strokeOpacity: 0.0,
            weight: 0.5,
            fillOpacity: 0.5
          };
        }
      });

      // Initialize the map with the first year value (1950)
      updateMapForYear(1950); // Apply the filter immediately to the initial year (1950)
      createTemporalLegend(1950); // Initialize the temporal legend with 1950

      // Add the filtered countries to the map (filtered by 1950)
      map.addLayer(filteredCountries);

      // Fit the map to the world
      map.fitWorld();
    };

    // Function to update the map for the selected year
    function updateMapForYear(year) {
      filteredCountries.clearLayers(); // Clear existing layers

      nations.eachLayer(function(layer) {
        // Define the properties
        const props = layer.feature.properties; // derive the properties of the target layer

        // Dynamically set styles for all nations based on percentage of US weapons
        // received in the slider designated year using the getColor function
        layer.setStyle({fillColor: getColor(props[year])});

        // Create an empty array
        const TIValues = [];

        // On hover, highlight the nation with a yellow border
        layer.on('mouseover', function() {
          // Clear the TIValues array
          TIValues.length = 0;

          // Set the mouseover style
          this.setStyle({
            weight: 2,
            color: 'yellow',
            fillOpacity: 0.7
          });

          // Bring the nation to the front
          this.bringToFront();

          // Remove any existing tooltip to avoid duplications
          this.unbindTooltip();

          // Add a tooltip with the nation's name and the sparkline placeholder
          this.bindTooltip(
            props.cntry_name + ' (' + year + ')<br>' + 
            props[year] + '% of US Weapons Exported<br>' +
            "National Trend:<br>1950 - 2023<br><span class='weaponspark'></span>",
          {
            sticky: true
          }).openTooltip();

          // Loop through a specific feature's properties and push values to the TIValues array
          for (let i = 1950; i <= 2023; i += 1) {
            TIValues.push(props[i]);
          }

          // Create sparklines with jQuery and .sparkline() method
          $('.weaponspark').sparkline(TIValues, {
            width: '160px',
            height: '30px',
            lineColor: '#67271d',
            fillColor: '#67271d',
            spotRadius: 0,
            lineWidth: 2,
            normalRangeMin: 0
          });
        });

        // On mouseout, reset the style
        layer.on('mouseout', function() {
          this.setStyle({
            weight: 0.5,
            color: 'grey',
            fillOpacity: 0.5
          });

          // Unbind the tooltip on mouseout to remove it
          this.unbindTooltip();
        });

        const startYear = props.gwsyear;
        const endYear = props.gweyear;

        // Check the year range and add countries to the filtered layer
        if (startYear <= year && endYear >= year) {
          filteredCountries.addLayer(layer);
        }
      });
    };

    // Function to handle slider input changes
    $('.slider').on('input', function() {
      const currentYear = Number($(this).val()); // Get the current year from the slider
      updateMapForYear(currentYear); // Call the function to update the map based on the selected year
      createTemporalLegend(currentYear); // Update the temporal legend to match the slider year
    });

    // Add a temporal legend in sync with the UI slider
    function createTemporalLegend(currentYear) {
      $('#temporal span').html(currentYear); // Change grade value to that currently selected by UI slider
    };

    // Add a function to style the nations by their percentage share of weapons
    function getColor(d) {
      return d > 8.13 ? '#b10026' :
           d > 4.65  ? '#e31a1c' :
           d > 3.36  ? '#fc4e2a' :
           d > 2.23  ? '#fd8d3c' :
           d > 1.16   ? '#feb24c' :
           d > 0.54   ? '#fed976' :
           d > 0.15   ? '#ffeda0' :
           d > 0.009   ? '#ffffcc' :
                      '#000000';
    };    
  </script>
</body>

</html>